# LLD 테스트 케이스 문서
# Low-Level Test Cases - MARKETDATA

| 항목 | 내용 |
|------|------|
| **문서 버전** | 1.0.0 |
| **작성일** | 2026-02-16 |
| **대상 모듈** | MARKETDATA (시세 데이터 수집 모듈) |
| **기반 문서** | LLD MARKETDATA v1.0.0, SRS v1.0.0 (FR-001, FR-002) |
| **관련 티켓** | TICKET-020-LLD-TEST-DOC-MARKETDATA |
| **산출물 경로** | `docs/tests/lld/lld-testcases-marketdata-v1.0.0.md` |

---

## 목차

1. [목적 및 범위](#1-목적-및-범위)
2. [테스트 전략 및 커버리지 목표](#2-테스트-전략-및-커버리지-목표)
3. [테스트 케이스 목록](#3-테스트-케이스-목록)
4. [상세 테스트 케이스](#4-상세-테스트-케이스)
5. [커버리지 매트릭스](#5-커버리지-매트릭스)
6. [요구사항 추적성 매트릭스](#6-요구사항-추적성-매트릭스)
7. [실행 우선순위 가이드](#7-실행-우선순위-가이드)

---

## 1. 목적 및 범위

본 문서는 `docs/lld/lld-marketdata-v1.0.0.md`의 구현 검증을 위한 LLD 수준 테스트 케이스를 정의한다.

- **검증 대상 컴포넌트**: `YahooFinanceClient`, `RSICalculator`, `MarketDataService`, `MarketDataCacheRepository`
- **검증 대상 시나리오**: 정상(핵심) 흐름 + 예외/오류 흐름
- **요구사항 추적 최소 범위**: SRS `FR-001`, `FR-002`

비범위:
- 전략 모듈(FR-003 이후) 직접 검증
- 웹 API/SSE UI 레벨 검증

---

## 2. 테스트 전략 및 커버리지 목표

### 2.1 전략

1. **단위 테스트**: 계산/검증/예외 변환의 순수 로직 검증
2. **서비스 통합 테스트**: 캐시-원격조회-RSI-저장 파이프라인 검증
3. **저장소 테스트**: upsert/read/TTL 경계값 검증
4. **장애 주입 테스트**: timeout/네트워크/무결성 오류 재현

### 2.2 커버리지 목표

- LLD 범위 항목(총 12개) 중 **최소 10개 이상 직접 검증**
- 목표 충족 기준: **83.3% 이상 (10/12)**
- 본 문서 설계 기준 예상 커버: **91.7% (11/12)**

---

## 3. 테스트 케이스 목록

| TC ID | 구분 | 시나리오 요약 | 관련 요구사항 | 우선순위 |
|------|------|----------------|---------------|----------|
| MD-TC-001 | Core | 5분봉 60일 데이터 정상 조회/정규화 | FR-001 | High |
| MD-TC-002 | Core | 거래시간 필터(09:00~15:30, 5분 단위) 적용 | FR-001 | High |
| MD-TC-003 | Core | 캐시 적중 시 원격 호출 없이 반환 | FR-001 | High |
| MD-TC-004 | Core | 캐시 미스 시 원격조회→검증→RSI→upsert | FR-001, FR-002 | High |
| MD-TC-005 | Core | RSI(14) 정상 산출 및 `0~100` 범위 | FR-002 | High |
| MD-TC-006 | Core | 입력 길이 부족 시 RSI NaN 처리 | FR-002 | Medium |
| MD-TC-007 | Core | 횡보 구간 RSI=50 처리 | FR-002 | Medium |
| MD-TC-008 | Core | 상승 단조 구간 RSI=100 수렴 | FR-002 | Medium |
| MD-TC-009 | Core | 캐시 Upsert 충돌 시 갱신 동작 | FR-001 | Medium |
| MD-TC-010 | Core | TTL 15분 경계값에서 cache fresh 판정 | FR-001 | Medium |
| MD-TC-011 | Exception | Timeout 1~2회 후 3회 내 성공 | FR-001 | High |
| MD-TC-012 | Exception | 3회 연속 Timeout 시 ExternalAPIError | FR-001 | High |
| MD-TC-013 | Exception | 빈 DataFrame 수신 시 NoDataError | FR-001 | High |
| MD-TC-014 | Exception | 필수 컬럼 누락 시 ValidationError | FR-001 | High |
| MD-TC-015 | Exception | NaN 포함 데이터 검증 실패 | FR-001 | Medium |
| MD-TC-016 | Exception | 거래량 음수 검증 실패 | FR-001 | Medium |
| MD-TC-017 | Exception | 가격 역전(`high < low`) 검증 실패 | FR-001 | Medium |
| MD-TC-018 | Exception | 범위 위반(`open/close` outside `[low,high]`) 검증 실패 | FR-001 | Medium |
| MD-TC-019 | Exception | 비거래시간 필터 후 0건 시 NoDataError | FR-001 | Medium |
| MD-TC-020 | Exception | 심볼 형식 오류(`.KS` 미포함) 입력 차단 | FR-001 | Medium |

---

## 4. 상세 테스트 케이스

### MD-TC-001

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-001 |
| **목적** | 코스피 심볼에 대해 60일/5분봉 OHLCV가 정상 조회되고 내부 컬럼으로 정규화되는지 검증 |
| **사전조건** | Yahoo 응답 mock에 `Open,High,Low,Close,Volume` 포함 300행 데이터 준비 |
| **재현 절차** | 1) `fetch_market_data_with_rsi('005930.KS','60d','5m')` 호출 2) 반환 DF 컬럼/행수 확인 |
| **입력** | `symbol=005930.KS`, `period=60d`, `interval=5m` |
| **기대 결과** | 반환 컬럼에 `timestamp, open, high, low, close, volume, rsi, fetched_at` 포함, 행수 > 0 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-002

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-002 |
| **목적** | 거래시간 외 데이터가 필터링되고 5분 경계 데이터만 유지되는지 검증 |
| **사전조건** | pre/post market 포함 mock DF 준비 |
| **재현 절차** | 1) 원본에 08:55, 09:00, 15:35 행 포함 2) 서비스 호출 3) 필터 결과 확인 |
| **입력** | KST timestamp 혼합 데이터 |
| **기대 결과** | 평일 09:00~15:30, `minute % 5 == 0` 행만 잔존 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-003

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-003 |
| **목적** | 캐시가 최신/범위충족일 때 원격 API 호출을 생략하는지 검증 |
| **사전조건** | 캐시에 요청 범위 전체 + TTL 15분 이내 데이터 저장 |
| **재현 절차** | 1) yahoo client mock call count 초기화 2) 서비스 호출 3) call count 확인 |
| **입력** | `symbol=005930.KS` |
| **기대 결과** | 반환값은 캐시 데이터, 원격 호출 횟수 0 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-004

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-004 |
| **목적** | 캐시 미스 시 원격조회→검증→RSI 계산→캐시 upsert 순서가 보장되는지 검증 |
| **사전조건** | 캐시 비우기, 각 단계 spy/mocking 가능 |
| **재현 절차** | 1) 서비스 호출 2) 단계별 호출 순서(assert call order) 검증 |
| **입력** | 정상 OHLCV 400행 |
| **기대 결과** | 정의된 파이프라인 순서로 1회 실행 후 enriched DF 반환 |
| **관련 요구사항 추적** | FR-001, FR-002 |
| **우선순위** | High |

### MD-TC-005

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-005 |
| **목적** | RSI(14) 산출 결과가 캔들별로 계산되고 범위가 0~100인지 검증 |
| **사전조건** | 20개 이상 close 시계열 준비 |
| **재현 절차** | 1) `calculate_rsi(df,14)` 호출 2) 값 범위 및 인덱스 정렬 확인 |
| **입력** | `Close` 컬럼 포함 DF |
| **기대 결과** | 유효 구간 RSI 값이 0 이상 100 이하 |
| **관련 요구사항 추적** | FR-002 |
| **우선순위** | High |

### MD-TC-006

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-006 |
| **목적** | 입력 길이 `< period+1`일 때 예외 대신 NaN 시리즈 반환 여부 검증 |
| **사전조건** | close 데이터 10개 준비(period=14) |
| **재현 절차** | `calculate_rsi(df,14)` 호출 후 NaN 비율 확인 |
| **입력** | 10행 DF |
| **기대 결과** | 전체 RSI 값 NaN, 예외 미발생 |
| **관련 요구사항 추적** | FR-002 |
| **우선순위** | Medium |

### MD-TC-007

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-007 |
| **목적** | 횡보(close 변화 0) 구간에서 RSI=50 처리 규칙 검증 |
| **사전조건** | 동일 close 반복 데이터 준비 |
| **재현 절차** | RSI 계산 후 유효 구간 값 비교 |
| **입력** | `close=[100,100,100,...]` |
| **기대 결과** | 계산 가능한 구간 RSI가 50(허용오차 ±0.5) |
| **관련 요구사항 추적** | FR-002 |
| **우선순위** | Medium |

### MD-TC-008

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-008 |
| **목적** | 손실이 없는 단조 상승 구간에서 RSI가 100으로 수렴하는지 검증 |
| **사전조건** | 증가 close 시계열 준비 |
| **재현 절차** | RSI 계산 후 후반부 구간 확인 |
| **입력** | `close=[100,101,102,...]` |
| **기대 결과** | 후반 구간 RSI 100(허용오차 ±0.5) |
| **관련 요구사항 추적** | FR-002 |
| **우선순위** | Medium |

### MD-TC-009

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-009 |
| **목적** | 동일 `(symbol,timestamp)` 충돌 시 upsert가 update로 동작하는지 검증 |
| **사전조건** | 동일 PK 데이터 2세트(가격값 상이) 준비 |
| **재현 절차** | 1) 최초 insert 2) 동일 PK upsert 3) 조회 비교 |
| **입력** | 동일 timestamp, 변경된 close/rsi |
| **기대 결과** | row 수는 유지, 값은 최신 입력으로 갱신 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-010

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-010 |
| **목적** | TTL 15분 최신성 경계값(`<=15m`, `>15m`) 판정 검증 |
| **사전조건** | now_kst 고정(테스트 더블) |
| **재현 절차** | 1) max timestamp = now-15m, now-15m-1s 각각 입력 2) `is_cache_fresh` 결과 확인 |
| **입력** | 동일 symbol/period/interval |
| **기대 결과** | 15분 이내=True, 초과=False |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-011

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-011 |
| **목적** | timeout이 발생해도 재시도 내 성공하면 정상 반환되는지 검증 |
| **사전조건** | yahoo mock: 1~2회 Timeout, 3회 정상 반환 설정 |
| **재현 절차** | 서비스 호출 후 retry 횟수와 최종 반환 확인 |
| **입력** | 정상 symbol |
| **기대 결과** | 총 호출 3회 이내 성공, 데이터 반환, 예외 없음 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-012

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-012 |
| **목적** | 3회 연속 timeout 시 최종 예외 타입이 표준화되는지 검증 |
| **사전조건** | yahoo mock: 항상 TimeoutError |
| **재현 절차** | 서비스 호출 후 예외 캡처 |
| **입력** | 정상 symbol |
| **기대 결과** | `ExternalAPIError('yahoo_fetch_failed_after_retries')` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-013

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-013 |
| **목적** | 빈 DataFrame 응답을 `NoDataError`로 처리하는지 검증 |
| **사전조건** | yahoo mock: empty DF 반환 |
| **재현 절차** | 서비스 호출 후 예외 확인 |
| **입력** | 정상 symbol |
| **기대 결과** | `NoDataError('no_market_data_in_requested_range')` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-014

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-014 |
| **목적** | 필수 컬럼 누락(`Volume` 등) 시 검증 실패 처리 검증 |
| **사전조건** | `Open,High,Low,Close`만 포함된 DF 준비 |
| **재현 절차** | `validate_market_data(df)` 호출 |
| **입력** | 필수 컬럼 일부 누락 DF |
| **기대 결과** | `ValidationError(missing_columns)` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | High |

### MD-TC-015

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-015 |
| **목적** | 필수 컬럼 NaN 존재 시 검증 실패 검증 |
| **사전조건** | close 컬럼 일부 NaN DF 준비 |
| **재현 절차** | `validate_market_data(df)` 호출 |
| **입력** | NaN 포함 DF |
| **기대 결과** | `ValidationError` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-016

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-016 |
| **목적** | 거래량 음수 데이터 차단 검증 |
| **사전조건** | 일부 행 `volume=-1` DF |
| **재현 절차** | `validate_market_data(df)` 호출 |
| **입력** | 음수 volume 포함 DF |
| **기대 결과** | `DataIntegrityError` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-017

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-017 |
| **목적** | `high < low` 가격 역전 레코드 차단 검증 |
| **사전조건** | 역전 레코드 1건 포함 DF |
| **재현 절차** | `validate_market_data(df)` 호출 |
| **입력** | high/low 무결성 위반 DF |
| **기대 결과** | `DataIntegrityError` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-018

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-018 |
| **목적** | `open` 또는 `close`가 `[low, high]` 범위를 벗어나는 경우 차단 검증 |
| **사전조건** | 범위 위반 레코드 1건 포함 DF |
| **재현 절차** | `validate_market_data(df)` 호출 |
| **입력** | 가격 범위 위반 DF |
| **기대 결과** | `DataIntegrityError` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-019

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-019 |
| **목적** | 필터링 후 유효 거래시간 데이터가 0건이면 NoDataError 처리 검증 |
| **사전조건** | 주말/야간 데이터만 포함 DF |
| **재현 절차** | 서비스 호출 후 예외 확인 |
| **입력** | 비거래시간 데이터 |
| **기대 결과** | `NoDataError` 발생 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

### MD-TC-020

| 항목 | 내용 |
|------|------|
| **ID** | MD-TC-020 |
| **목적** | `.KS`가 없는 심볼 입력을 서비스 진입 시 차단하는지 검증 |
| **사전조건** | 입력 검증 활성화 |
| **재현 절차** | `fetch_market_data_with_rsi('AAPL','60d','5m')` 호출 |
| **입력** | `symbol=AAPL` |
| **기대 결과** | 입력 검증 오류(Assertion/ValidationError) 발생, 외부 API 미호출 |
| **관련 요구사항 추적** | FR-001 |
| **우선순위** | Medium |

---

## 5. 커버리지 매트릭스

### 5.1 LLD 범위 항목 대비 커버리지

| LLD 검증 항목 | 핵심 내용 | 대응 TC ID | 커버 여부 |
|---------------|-----------|------------|-----------|
| COV-01 | Yahoo 60d/5m 조회 규약 | MD-TC-001, 004 | ✅ |
| COV-02 | 컬럼 정규화/반환 스키마 | MD-TC-001 | ✅ |
| COV-03 | 거래시간 필터 | MD-TC-002, 019 | ✅ |
| COV-04 | 캐시 hit/miss 분기 | MD-TC-003, 004 | ✅ |
| COV-05 | TTL 15분 최신성 | MD-TC-010 | ✅ |
| COV-06 | retry/backoff 정책 | MD-TC-011, 012 | ✅ |
| COV-07 | 필수 컬럼/NaN 검증 | MD-TC-014, 015 | ✅ |
| COV-08 | 무결성(가격/거래량) 검증 | MD-TC-016, 017, 018 | ✅ |
| COV-09 | RSI(14) 계산 규칙 | MD-TC-005, 006, 007, 008 | ✅ |
| COV-10 | RSI 범위 보정(0~100) | MD-TC-005, 008 | ✅ |
| COV-11 | 캐시 Upsert 동작 | MD-TC-009 | ✅ |
| COV-12 | 타임존 정규화 분기 | 별도 통합테스트 필요 (v1.0.1 보강) | ⚠️ 부분 |

**커버리지 요약**
- 전체 항목: 12
- 직접 커버: 11
- 예상 커버율: **91.7%**

### 5.2 시나리오 유형별 분포

| 분류 | 건수 | 비율 |
|------|------|------|
| Core 시나리오 | 10 | 50% |
| Exception 시나리오 | 10 | 50% |
| 합계 | 20 | 100% |

---

## 6. 요구사항 추적성 매트릭스

| 요구사항 ID | 요구사항 요약 | 대응 테스트 케이스 | 커버 상태 |
|-------------|---------------|--------------------|-----------|
| FR-001 | 코스피 종목 5분 분봉 최근 60일 조회 | MD-TC-001, 002, 003, 004, 009, 010, 011, 012, 013, 014, 015, 016, 017, 018, 019, 020 | ✅ 충족 |
| FR-002 | RSI(14) 산출, 0~100 범위, 캔들별 계산 | MD-TC-004, 005, 006, 007, 008 | ✅ 충족 |

---

## 7. 실행 우선순위 가이드

- **P0 (배포 게이트 필수)**: MD-TC-001, 003, 004, 005, 011, 012, 013, 014
- **P1 (릴리즈 전 필수)**: MD-TC-002, 009, 010, 015, 016, 017, 018, 019
- **P2 (회귀/보강)**: MD-TC-006, 007, 008, 020

권장 실행 순서:
1. P0 전수 실행
2. P1 전수 실행
3. P2 선택 실행 후 회귀 스위트 포함
